description: >
  Update needed branch with an new version of a service
parameters:
  branch:
    default: "t1"
    type: string
  stack:
    default: "admin"
    type: string
  circle_project_repo_name:
    type: string
    default: ""
  circle_tag:
    type: string
    default: ""
  yq_version:
    type: string
    default: "3.4.1"
  yq_binary:
    type: string
    default: "yq_linux_amd64"
steps:
  - run:
      name: Choose appropriate repo name and tag
      command: |
        [ -z "<<parameters.circle_project_repo_name>>" ] && export service=$CIRCLE_PROJECT_REPO_NAME
        [ -n "<<parameters.circle_project_repo_name>>" ] && export service=<<parameters.circle_project_repo_name>>
        [ -z "<<parameters.circle_tag>>" ] && export image=$CIRCLE_TAG
        [ -n "<<parameters.circle_tag>>" ] && export image=<<parameters.circle_tag>>
  - run: git branch --set-upstream-to=origin/<<parameters.branch>> <<parameters.branch>>
  - run: git pull
  - run: wget https://github.com/mikefarah/yq/releases/download/<<parameters.yq_version>>/<<parameters.yq_binary>> -O ~/yq && chmod +x ~/yq
  - run: ~/yq w -i docker-compose.<<parameters.stack>>.yml services.$service.image "$image"
  - run: git status
  - run: git commit -a -m "Bumping <<parameters.circle_project_repo_name>> version to <<parameters.circle_tag>>"
  - run: git push
